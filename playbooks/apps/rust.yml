---
- name: Configure Rust toolchain
  hosts: all
  become: false
  vars:
    rustup_script: /tmp/rustup-init.sh
    rust_bin: "{{ ansible_facts['env'].HOME }}/.cargo/bin/rustc"

  tasks:

    - name: Check if Rust is already installed
      ansible.builtin.stat:
        path: "{{ rust_bin }}"
      register: rust_stat

    - name: Download rustup installer
      ansible.builtin.get_url:
        url: https://sh.rustup.rs
        dest: "{{ rustup_script }}"
        mode: '0755'
      when: not rust_stat.stat.exists

    - name: Run rustup installer (non-interactive)
      ansible.builtin.command: "{{ rustup_script }} -y"
      when: not rust_stat.stat.exists
      changed_when: true

    # Until the shell is restarted, cargo won't be in the $PATH.
